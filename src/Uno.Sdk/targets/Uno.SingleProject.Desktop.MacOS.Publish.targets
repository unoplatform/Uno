<Project>
	<UsingTask TaskName="Uno.Sdk.Tasks.GenerateSkiaDesktopMacOSBundle_v0"
		AssemblyFile="$(MSBuildThisFileDirectory)netstandard2.0\Uno.Sdk_v0.dll" />

	<PropertyGroup Condition="$(_IsPublishing) == 'true'">
		<SelfContained>true</SelfContained>
	</PropertyGroup>

	<Target Name="RedirectPublishDir"
			BeforeTargets="PrepareForPublish">
		<PropertyGroup>
			<_UnoAppPackagePublishDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(PublishDir)))))</_UnoAppPackagePublishDir>
			<_UnoPublishDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(IntermediateOutputPath), 'unopublish'))))</_UnoPublishDir>
			<PublishDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(_UnoPublishDir), 'raw'))))</PublishDir>
			<_UnoAppBundleTempDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath('$(_UnoPublishDir)', '$(ApplicationTitle).app'))))</_UnoAppBundleTempDir>
			<_UnoAppBundleTempContentsDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(_UnoAppBundleTempDir), 'Contents'))))</_UnoAppBundleTempContentsDir>
			<_UnoAppBundleTempMacOSDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(_UnoAppBundleTempContentsDir), 'MacOS'))))</_UnoAppBundleTempMacOSDir>
			<_UnoAppBundleTempResourcesDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(_UnoAppBundleTempContentsDir), 'Resources'))))</_UnoAppBundleTempResourcesDir>
		</PropertyGroup>

		<RemoveDir Directories="$(_UnoAppPackagePublishDir)" />
		<RemoveDir Directories="$(_UnoPublishDir)" />
	</Target>

	<Target Name="GenerateMacOSAppBundle"
			AfterTargets="Publish">
		<PropertyGroup>
			<TargetCulture Condition="$(TargetCulture) == ''">en</TargetCulture>
			<PackageFormat Condition="$(PackageFormat) == ''">app</PackageFormat>
		</PropertyGroup>
		
		<ItemGroup>
			<!-- This shouldn't happen but we want to prevent non-MacOS runtimes from being included. -->
			<PublishExclude Include="$(PublishDir)/**/runtimes/win*/**" />
			<PublishExclude Include="$(PublishDir)/**/runtimes/linux*/**" />
			<PublishExclude Include="$(PublishDir)/**/runtimes/unix*/**" />
			<PublishExclude Include="$(PublishDir)/**/*.ico" />
			<_UnoPublishedFiles Include="$(PublishDir)/**" Exclude="@(PublishExclude)" PublishDir="$(_UnoAppBundleTempMacOSDir)%(RecursiveDir)%(Filename)%(Extension)"/>
			<_PublishedIcon Include="$(_UnoIntermediateImages)Assets.xcassets/*.appiconset/**" />
		</ItemGroup>

		<Copy SourceFiles="@(_UnoPublishedFiles)"
			DestinationFiles="@(_UnoPublishedFiles->'$(_UnoAppBundleTempMacOSDir)%(RecursiveDir)%(Filename)%(Extension)')"
			SkipUnchangedFiles="true" />

		<GenerateSkiaDesktopMacOSBundle_v0
			AssemblyName="$(AssemblyName)"
			SdkDebugging="$(UnoSdkDebugging)"
			BundledDotNetVersion="$(BundledNETCorePlatformsPackageVersion)"
			UnoVersion="$(UnoVersion)"
			TargetCulture="$(TargetCulture)"
			ApplicationDisplayVersion="$(ApplicationDisplayVersion)"
			ApplicationVersion="$(ApplicationVersion)"
			AppBundleDirectory="@(_UnoAppBundleTempMacOSDir)"
			PartialPlists="@(SkiaInfoPlist)"
			EntitlementPlists="@(SkiaEntitlementsPlist)"
			AppIconSets="@(_PublishedIcon)" />
	</Target>
</Project>
