<Project>
	<UsingTask TaskName="Uno.Sdk.Tasks.GenerateSkiaDesktopMacOSBundle_v0"
		AssemblyFile="$(MSBuildThisFileDirectory)netstandard2.0\Uno.Sdk_v0.dll" />

	<PropertyGroup Condition="$(_IsPublishing) == 'true'">
		<SelfContained>true</SelfContained>
	</PropertyGroup>

	<Target Name="RedirectPublishDir"
			BeforeTargets="PrepareForPublish">
		<PropertyGroup>
			<_UnoAppPackagePublishDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(PublishDir)))))</_UnoAppPackagePublishDir>
			<_UnoPublishDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(IntermediateOutputPath), 'unopublish'))))</_UnoPublishDir>
			<PublishDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(_UnoPublishDir), 'raw'))))</PublishDir>
			<_UnoAppBundleTempDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath('$(_UnoPublishDir)', '$(ApplicationTitle).app'))))</_UnoAppBundleTempDir>
			<_UnoAppBundleTempContentsDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(_UnoAppBundleTempDir), 'Contents'))))</_UnoAppBundleTempContentsDir>
			<_UnoAppBundleTempMacOSDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(_UnoAppBundleTempContentsDir), 'MacOS'))))</_UnoAppBundleTempMacOSDir>
			<_UnoAppBundleTempResourcesDir>$([MSBuild]::EnsureTrailingSlash($([MSBuild]::NormalizePath($(_UnoAppBundleTempContentsDir), 'Resources'))))</_UnoAppBundleTempResourcesDir>
		</PropertyGroup>

		<RemoveDir Directories="$(_UnoAppPackagePublishDir)" />
		<RemoveDir Directories="$(_UnoPublishDir)" />
	</Target>

	<Target Name="GenerateMacOSAppBundle"
			AfterTargets="Publish">
		<PropertyGroup>
			<TargetCulture Condition="$(TargetCulture) == '' OR $(TargetCulture) == '*'">en-US</TargetCulture>
			<PackageFormat Condition="$(PackageFormat) == ''">app</PackageFormat>
		</PropertyGroup>
		
		<ItemGroup>
			<PublishExclude Include="$(PublishDir)/**/*.ico" />
			<_UnoPublishedFiles Include="$(PublishDir)/**" Exclude="@(PublishExclude)" PublishDir="$(_UnoAppBundleTempMacOSDir)%(RecursiveDir)%(Filename)%(Extension)"/>
			<_PublishedIcon Include="$(_UnoIntermediateImages)Assets.xcassets/*.appiconset/Contents.json" />
			<_PackageAppxManifest Include="@(EmbeddedResource)" Condition="'%(Filename)%(Extension)' == 'Package.appxmanifest'" />
		</ItemGroup>

		<Copy SourceFiles="@(_UnoPublishedFiles)"
			DestinationFiles="@(_UnoPublishedFiles->'$(_UnoAppBundleTempMacOSDir)%(RecursiveDir)%(Filename)%(Extension)')"
			SkipUnchangedFiles="true" />

		<GenerateSkiaDesktopMacOSBundle_v0
			AssemblyName="$(AssemblyName)"
			SdkDebugging="$(UnoSdkDebugging)"
			BundledDotNetVersion="$(BundledNETCorePlatformsPackageVersion)"
			UnoVersion="$(UnoVersion)"
			TargetCulture="$(TargetCulture)"
			ApplicationDisplayVersion="$(ApplicationDisplayVersion)"
			ApplicationVersion="$(ApplicationVersion)"
			AppBundleDirectory="$(_UnoAppBundleTempDir)"
			PartialPlists="@(SkiaInfoPlist)"
			EntitlementPlists="@(SkiaEntitlementsPlist)"
			AppIconSets="@(_PublishedIcon)"
			EmbeddedResources="@(_PackageAppxManifest)" />
	</Target>

	<Target Name="PublishMacOSAppBundle"
			AfterTargets="GenerateMacOSAppBundle">
		<ItemGroup>
			<_UnoAppBundleFiles Include="$(_UnoPublishDir)$(ApplicationTitle).app/**" />
		</ItemGroup>

		<Copy SourceFiles="@(_UnoAppBundleFiles)"
			DestinationFiles="@(_UnoAppBundleFiles->'$(UnoAppPackagePublishDir)$(ApplicationTitle).app/%(RecursiveDir)%(Filename)%(Extension)')"
			SkipUnchangedFiles="true" />

		<Message Text="$(AssemblyName) -&gt; $(_UnoPublishDir)$(ApplicationTitle).app" Importance="High" />
	</Target>
</Project>
